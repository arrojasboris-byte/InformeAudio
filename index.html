# Create project directory structure
base_dir = "/mnt/data/ControlCenterAudio"
os.makedirs(base_dir, exist_ok=True)
os.makedirs(os.path.join(base_dir, "css"), exist_ok=True)
os.makedirs(os.path.join(base_dir, "js"), exist_ok=True)
os.makedirs(os.path.join(base_dir, "assets"), exist_ok=True)

index_html = """<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control Center Audio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="cca-body">
  <div class="cca-app d-flex">
    <!-- Sidebar -->
    <aside class="cca-sidebar d-flex flex-column">
      <div class="text-center py-3 border-bottom border-light-subtle">
        <div class="fw-bold fs-5 text-light">Control Center</div>
        <div class="fw-semibold text-warning">AUDIO</div>
      </div>
      <nav class="nav flex-column mt-3 cca-sidebar-nav">
        <button class="nav-link active" data-section="dashboard">
          <i class="bi bi-speedometer2 me-2"></i>Dashboard
        </button>
        <button class="nav-link" data-section="centros">
          <i class="bi bi-building me-2"></i>Centros
        </button>
        <button class="nav-link" data-section="visitas">
          <i class="bi bi-calendar-event me-2"></i>Visitas
        </button>
        <button class="nav-link" data-section="exclusivos">
          <i class="bi bi-gem me-2"></i>Centros exclusivos
        </button>
        <button class="nav-link" data-section="proyectos">
          <i class="bi bi-kanban me-2"></i>Proyectos
        </button>
        <button class="nav-link" data-section="servicio-aar">
          <i class="bi bi-headset me-2"></i>Servicio AAR
        </button>
      </nav>
      <div class="mt-auto p-3 text-center small text-light-50">
        v1.0 · HTML
      </div>
    </aside>

    <!-- Main content -->
    <main class="cca-main flex-grow-1">
      <!-- Top bar -->
      <header class="cca-topbar d-flex align-items-center gap-3">
        <div class="flex-grow-1 position-relative">
          <i class="bi bi-search cca-search-icon"></i>
          <input id="globalSearch" class="form-control cca-search-input" placeholder="Buscar en todo Control Center Audio..." />
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-cca-3d" id="btnSaveLocal" title="Guardar local">
            <i class="bi bi-device-hdd"></i>
          </button>
          <button class="btn btn-cca-3d" id="btnSaveCloud" title="Guardar en nube (descargar backup)">
            <i class="bi bi-cloud-arrow-down"></i>
          </button>
          <button class="btn btn-cca-3d" id="btnLoadCloud" title="Actualizar desde nube (cargar backup)">
            <i class="bi bi-cloud-arrow-up"></i>
          </button>
          <button class="btn btn-cca-3d" id="btnDownloadHtml" title="Descargar HTML actual">
            <i class="bi bi-filetype-html"></i>
          </button>
          <input type="file" id="cloudFileInput" accept="application/json" class="d-none" />
        </div>
      </header>

      <!-- Sections wrapper -->
      <section id="dashboard" class="cca-section active">
        <div class="container-fluid py-3">
          <h2 class="section-title mb-3"><i class="bi bi-speedometer2 me-2"></i>Visión general</h2>
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <div class="cca-kpi-card">
                <div class="kpi-label">% Procesos</div>
                <div class="kpi-value" id="kpiProcesos">0%</div>
                <div class="kpi-sub" id="kpiProcesosSub">Basado en checklist cargados</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="cca-kpi-card">
                <div class="kpi-label">Conv. a prueba</div>
                <div class="kpi-value" id="kpiPrueba">0%</div>
                <div class="kpi-sub">Media sobre todos los centros</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="cca-kpi-card">
                <div class="kpi-label">Conv. a venta</div>
                <div class="kpi-value" id="kpiVenta">0%</div>
                <div class="kpi-sub">Media sobre todos los centros</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="cca-kpi-card">
                <div class="kpi-label">Centros con HIT</div>
                <div class="kpi-value" id="kpiHit">0</div>
                <div class="kpi-sub">Aplica HIT</div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="cca-panel h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">Ranking de centros por conversión a venta</h5>
                  <span class="badge bg-warning-subtle text-dark small">Corner & Exclusivos</span>
                </div>
                <div class="table-responsive small" style="max-height:280px;">
                  <table class="table table-sm table-hover align-middle" id="tablaRankingCentros">
                    <thead class="table-light">
                      <tr>
                        <th>Centro</th>
                        <th>Delegado</th>
                        <th>Tipo</th>
                        <th class="text-end">Conv. venta</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Filled by JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="cca-panel h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">KPIs globales</h5>
                  <span class="text-muted small">Actualizado con cada checklist</span>
                </div>
                <canvas id="kpiChart" height="140"></canvas>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-lg-7">
              <div class="cca-panel h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">Mapa de centros</h5>
                  <span class="text-muted small">España · por delegado</span>
                </div>
                <div id="mapCentros" class="cca-map"></div>
              </div>
            </div>
            <div class="col-lg-5">
              <div class="cca-panel h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">Estado de visitas</h5>
                  <span class="text-muted small">Pendientes / realizadas / anuladas</span>
                </div>
                <canvas id="visitasChart" height="160"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- CENTROS -->
      <section id="centros" class="cca-section">
        <div class="container-fluid py-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title mb-0"><i class="bi bi-building me-2"></i>Centros</h2>
            <button class="btn btn-sm btn-primary rounded-pill px-3" id="btnNuevoCentro">
              <i class="bi bi-plus-lg me-1"></i>Nuevo centro
            </button>
          </div>

          <div class="row g-3">
            <div class="col-lg-5">
              <div class="cca-panel mb-3">
                <h5 class="mb-3">Ficha de centro</h5>
                <form id="formCentro" class="small">
                  <div class="row g-2">
                    <div class="col-md-8">
                      <label class="form-label">Nombre centro</label>
                      <input type="text" class="form-control" id="centroNombre" required />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Código</label>
                      <input type="text" class="form-control" id="centroCodigo" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Delegado</label>
                      <input type="text" class="form-control" id="centroDelegado" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Tipo</label>
                      <select class="form-select" id="centroTipo">
                        <option value="CORNER">Corner</option>
                        <option value="EXCLUSIVO">Exclusivo</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Provincia</label>
                      <input type="text" class="form-control" id="centroProvincia" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Lat</label>
                      <input type="number" step="0.0001" class="form-control" id="centroLat" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Lng</label>
                      <input type="number" step="0.0001" class="form-control" id="centroLng" />
                    </div>
                    <div class="col-12">
                      <label class="form-label">Checklist Excel</label>
                      <input type="file" id="centroChecklist" class="form-control" accept=".xlsx,.xls" />
                      <div class="form-text">
                        El sistema detecta si es Corner o Exclusivo y extrae KPIs automáticamente.
                      </div>
                    </div>
                  </div>
                  <div class="mt-3 d-flex justify-content-end gap-2">
                    <button type="reset" class="btn btn-sm btn-outline-secondary">Limpiar</button>
                    <button type="submit" class="btn btn-sm btn-success">
                      <i class="bi bi-check-circle me-1"></i>Guardar centro
                    </button>
                  </div>
                </form>
              </div>

              <div class="cca-panel small">
                <h6 class="mb-2">Resumen KPIs del centro seleccionado</h6>
                <div class="row text-center">
                  <div class="col-3">
                    <div class="mini-kpi-label">% Proc.</div>
                    <div class="mini-kpi-value" id="centroKpiProcesos">-</div>
                  </div>
                  <div class="col-3">
                    <div class="mini-kpi-label">HIT</div>
                    <div class="mini-kpi-value" id="centroKpiHit">-</div>
                  </div>
                  <div class="col-3">
                    <div class="mini-kpi-label">Conv. Prueba</div>
                    <div class="mini-kpi-value" id="centroKpiPrueba">-</div>
                  </div>
                  <div class="col-3">
                    <div class="mini-kpi-label">Conv. Venta</div>
                    <div class="mini-kpi-value" id="centroKpiVenta">-</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-7">
              <div class="cca-panel mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">Mapa de centros</h5>
                  <span class="small text-muted">Colores por delegado</span>
                </div>
                <div id="mapCentrosSection" class="cca-map"></div>
              </div>

              <div class="cca-panel small">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Listado de centros</h6>
                  <input type="text" id="filtroCentros" class="form-control form-control-sm w-auto" placeholder="Filtrar..." />
                </div>
                <div class="table-responsive" style="max-height:260px;">
                  <table class="table table-sm table-hover align-middle" id="tablaCentros">
                    <thead class="table-light">
                      <tr>
                        <th>Centro</th>
                        <th>Delegado</th>
                        <th>Tipo</th>
                        <th>Provincia</th>
                        <th class="text-end">Conv. venta</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- VISITAS -->
      <section id="visitas" class="cca-section">
        <div class="container-fluid py-3">
          <h2 class="section-title mb-3"><i class="bi bi-calendar-event me-2"></i>Visitas</h2>

          <div class="row g-3">
            <div class="col-lg-5">
              <div class="cca-panel mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">Calendario</h5>
                  <div class="d-flex align-items-center gap-2 small">
                    <button class="btn btn-sm btn-outline-light" id="btnPrevMes"><i class="bi bi-chevron-left"></i></button>
                    <span id="labelMes"></span>
                    <button class="btn btn-sm btn-outline-light" id="btnNextMes"><i class="bi bi-chevron-right"></i></button>
                  </div>
                </div>
                <div id="visitasCalendar"></div>
                <div class="mt-2 small">
                  <span class="me-3"><span class="estado-dot estado-pendiente"></span> Pendiente</span>
                  <span class="me-3"><span class="estado-dot estado-realizada"></span> Realizada</span>
                  <span><span class="estado-dot estado-anulada"></span> Anulada</span>
                </div>
              </div>

              <div class="cca-panel small">
                <h6 class="mb-2">Programar nueva visita</h6>
                <form id="formNuevaVisita">
                  <div class="mb-2">
                    <label class="form-label">Fecha seleccionada</label>
                    <input type="text" class="form-control form-control-sm" id="visitaFecha" readonly />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Centro</label>
                    <select class="form-select form-select-sm" id="visitaCentro"></select>
                    <div class="form-text">Centros cargados en la sección "Centros".</div>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Resp-Audio</label>
                    <select class="form-select form-select-sm" id="visitaRespAudio">
                      <option value="Ariannys Rojas">Ariannys Rojas</option>
                      <option value="Sonia Guasque">Sonia Guasque</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Estado inicial</label>
                    <select class="form-select form-select-sm" id="visitaEstado">
                      <option value="pendiente">Pendiente (ámbar)</option>
                      <option value="realizada">Realizada (verde)</option>
                      <option value="anulada">Anulada (rojo)</option>
                    </select>
                  </div>
                  <div class="d-flex justify-content-end gap-2">
                    <button type="reset" class="btn btn-sm btn-outline-secondary">Limpiar</button>
                    <button type="submit" class="btn btn-sm btn-primary">
                      <i class="bi bi-plus-lg me-1"></i>Agendar visita
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <div class="col-lg-7">
              <div class="cca-panel mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">Visitas del día seleccionado</h5>
                  <span class="small text-muted" id="labelVisitasDia"></span>
                </div>
                <div class="table-responsive small" style="max-height:220px;">
                  <table class="table table-sm table-hover align-middle" id="tablaVisitas">
                    <thead class="table-light">
                      <tr>
                        <th>Centro</th>
                        <th>Resp-Audio</th>
                        <th>Estado</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- JS -->
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="cca-panel">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">Informe de visita</h5>
                  <span class="small text-muted">Se activa al comenzar una visita</span>
                </div>
                <div id="informeContainer">
                  <p class="small text-muted mb-0">Selecciona una visita y pulsa <strong>"Comenzar informe"</strong> para rellenar los datos.</p>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- CENTROS EXCLUSIVOS -->
      <section id="exclusivos" class="cca-section">
        <div class="container-fluid py-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title mb-0"><i class="bi bi-gem me-2"></i>Centros exclusivos</h2>
            <button class="btn btn-sm btn-primary rounded-pill px-3" id="btnNuevoExclusivo">
              <i class="bi bi-plus-lg me-1"></i>Añadir registro
            </button>
          </div>

          <div class="row g-3">
            <div class="col-lg-5">
              <div class="cca-panel small">
                <h5 class="mb-3">Datos por centro</h5>
                <form id="formExclusivo">
                  <div class="mb-2">
                    <label class="form-label">Centro</label>
                    <input type="text" class="form-control form-control-sm" id="exCentro" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Periodo</label>
                    <select class="form-select form-select-sm" id="exPeriodo">
                      <option value="ago2025-jul2026">Ago 2025 - Jul 2026</option>
                    </select>
                  </div>
                  <div class="row g-2">
                    <div class="col-6">
                      <label class="form-label">Cifra real</label>
                      <input type="number" class="form-control form-control-sm" id="exCifraReal" />
                    </div>
                    <div class="col-6">
                      <label class="form-label">Cifra estimada</label>
                      <input type="number" class="form-control form-control-sm" id="exCifraEstimada" />
                    </div>
                  </div>
                  <div class="mb-2 mt-2">
                    <label class="form-label">Acciones</label>
                    <select class="form-select form-select-sm" id="exAccion">
                      <option value="Azafata">Azafata</option>
                      <option value="Call center">Call center</option>
                      <option value="Mailing">Mailing</option>
                      <option value="Ruleta">Ruleta</option>
                      <option value="Buzoneo">Buzoneo</option>
                      <option value="Cashback">Cashback</option>
                      <option value="Comercio amigo">Comercio amigo</option>
                      <option value="Otros">Otros</option>
                    </select>
                  </div>
                  <div class="row g-2">
                    <div class="col-6">
                      <label class="form-label">Derivaciones</label>
                      <input type="number" class="form-control form-control-sm" id="exDerivaciones" />
                    </div>
                    <div class="col-6">
                      <label class="form-label">Citas</label>
                      <input type="number" class="form-control form-control-sm" id="exCitas" />
                    </div>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Observaciones</label>
                    <textarea class="form-control form-control-sm" id="exObs" rows="2"></textarea>
                  </div>
                  <div class="d-flex justify-content-end gap-2">
                    <button type="reset" class="btn btn-sm btn-outline-secondary">Limpiar</button>
                    <button type="submit" class="btn btn-sm btn-success">
                      <i class="bi bi-check-circle me-1"></i>Guardar
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <div class="col-lg-7">
              <div class="cca-panel mb-3 small">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Monitoreo global</h6>
                  <span class="small text-muted">Real vs estimado (acumulado)</span>
                </div>
                <canvas id="exclusivosChart" height="140"></canvas>
              </div>

              <div class="cca-panel small">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Detalle por centro</h6>
                  <input type="text" id="filtroExclusivos" class="form-control form-control-sm w-auto" placeholder="Filtrar..." />
                </div>
                <div class="table-responsive" style="max-height:260px;">
                  <table class="table table-sm table-hover align-middle" id="tablaExclusivos">
                    <thead class="table-light">
                      <tr>
                        <th>Centro</th>
                        <th>Periodo</th>
                        <th class="text-end">Real</th>
                        <th class="text-end">Estimado</th>
                        <th class="text-end">Dif.</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- PROYECTOS -->
      <section id="proyectos" class="cca-section">
        <div class="container-fluid py-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title mb-0"><i class="bi bi-kanban me-2"></i>Proyectos</h2>
            <button class="btn btn-sm btn-primary rounded-pill px-3" id="btnNuevoProyecto">
              <i class="bi bi-plus-lg me-1"></i>Nuevo proyecto
            </button>
          </div>

          <div class="row g-3">
            <div class="col-lg-5">
              <div class="cca-panel small">
                <h5 class="mb-3">Ficha de proyecto</h5>
                <form id="formProyecto">
                  <div class="mb-2">
                    <label class="form-label">Nombre del proyecto</label>
                    <input type="text" class="form-control form-control-sm" id="projNombre" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Responsable</label>
                    <input type="text" class="form-control form-control-sm" id="projResponsable" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Equipo</label>
                    <input type="text" class="form-control form-control-sm" id="projEquipo" placeholder="Separar por comas" />
                  </div>
                  <div class="row g-2">
                    <div class="col-6">
                      <label class="form-label">Fecha inicio</label>
                      <input type="date" class="form-control form-control-sm" id="projInicio" />
                    </div>
                    <div class="col-6">
                      <label class="form-label">Fecha fin</label>
                      <input type="date" class="form-control form-control-sm" id="projFin" />
                    </div>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Estado</label>
                    <select class="form-select form-select-sm" id="projEstado">
                      <option value="pendiente">Pendiente</option>
                      <option value="proceso">En proceso</option>
                      <option value="terminado">Terminado</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Notas</label>
                    <textarea class="form-control form-control-sm" id="projNotas" rows="2"></textarea>
                  </div>
                  <div class="d-flex justify-content-end gap-2">
                    <button type="reset" class="btn btn-sm btn-outline-secondary">Limpiar</button>
                    <button type="submit" class="btn btn-sm btn-success">
                      <i class="bi bi-check-circle me-1"></i>Guardar
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <div class="col-lg-7">
              <div class="cca-panel small">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Listado de proyectos</h6>
                  <input type="text" id="filtroProyectos" class="form-control form-control-sm w-auto" placeholder="Filtrar..." />
                </div>
                <div class="table-responsive" style="max-height:340px;">
                  <table class="table table-sm table-hover align-middle" id="tablaProyectos">
                    <thead class="table-light">
                      <tr>
                        <th>Proyecto</th>
                        <th>Responsable</th>
                        <th>Estado</th>
                        <th>Inicio</th>
                        <th>Fin</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- SERVICIO AAR -->
      <section id="servicio-aar" class="cca-section">
        <div class="container-fluid py-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title mb-0"><i class="bi bi-headset me-2"></i>Servicio AAR</h2>
            <button class="btn btn-sm btn-primary rounded-pill px-3" id="btnNuevoAar">
              <i class="bi bi-plus-lg me-1"></i>Añadir centro
            </button>
          </div>

          <div class="row g-3">
            <div class="col-lg-5">
              <div class="cca-panel small">
                <h5 class="mb-3">Centro con Servicio AAR</h5>
                <form id="formAar">
                  <div class="mb-2">
                    <label class="form-label">Centro</label>
                    <input type="text" class="form-control form-control-sm" id="aarCentro" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Estado de formación</label>
                    <select class="form-select form-select-sm" id="aarEstadoForm">
                      <option value="formacion">En formación</option>
                      <option value="certificado">Certificado</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Perfil</label>
                    <select class="form-select form-select-sm" id="aarPerfil">
                      <option value="audiologo">Audiólogo</option>
                      <option value="tecnico">Técnico</option>
                      <option value="ambos">Ambos</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Marcador de procesos (0-100%)</label>
                    <input type="number" min="0" max="100" class="form-control form-control-sm" id="aarProcesos" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Observaciones</label>
                    <textarea class="form-control form-control-sm" id="aarObs" rows="2"></textarea>
                  </div>
                  <div class="d-flex justify-content-end gap-2">
                    <button type="reset" class="btn btn-sm btn-outline-secondary">Limpiar</button>
                    <button type="submit" class="btn btn-sm btn-success">
                      <i class="bi bi-check-circle me-1"></i>Guardar</button>
                  </div>
                </form>
              </div>
            </div>

            <div class="col-lg-7">
              <div class="cca-panel small mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Estado global</h6>
                  <span class="small text-muted">Formación / certificados · procesos</span>
                </div>
                <canvas id="aarChart" height="140"></canvas>
              </div>

              <div class="cca-panel small">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Listado de centros AAR</h6>
                  <input type="text" id="filtroAar" class="form-control form-control-sm w-auto" placeholder="Filtrar..." />
                </div>
                <div class="table-responsive" style="max-height:260px;">
                  <table class="table table-sm table-hover align-middle" id="tablaAar">
                    <thead class="table-light">
                      <tr>
                        <th>Centro</th>
                        <th>Estado</th>
                        <th>Perfil</th>
                        <th class="text-end">Procesos</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- JS -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Hidden template for informe de visita -->
  <template id="tplInformeVisita">
    <div id="informe-visita" class="informe-visita small">
      <div class="row g-3">
        <div class="col-md-8">
          <h6 class="mb-2">Informe de visita audio</h6>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Fecha</label>
              <input type="text" class="form-control form-control-sm" id="infFecha" readonly />
            </div>
            <div class="col-md-4">
              <label class="form-label">Centro</label>
              <input type="text" class="form-control form-control-sm" id="infCentro" readonly />
            </div>
            <div class="col-md-4">
              <label class="form-label">Resp-Audio</label>
              <input type="text" class="form-control form-control-sm" id="infRespAudio" readonly />
            </div>
            <div class="col-md-4">
              <label class="form-label">Audiólogo</label>
              <input type="text" class="form-control form-control-sm" id="infAudiologo" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Horas servicio</label>
              <input type="number" step="0.5" class="form-control form-control-sm" id="infHoras" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Tipo implantación</label>
              <div class="d-flex gap-2">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="infTipo" id="infTipoCorner" value="CORNER">
                  <label class="form-check-label" for="infTipoCorner">Corner</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="infTipo" id="infTipoExclusivo" value="EXCLUSIVO">
                  <label class="form-check-label" for="infTipoExclusivo">Centro exclusivo</label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Adjuntar checklist Excel</label>
          <input type="file" id="infChecklist" class="form-control form-control-sm" accept=".xlsx,.xls" />
          <div class="form-text">Se usarán los KPIs definidos (procesos, HIT, conversión...).</div>
          <div class="mt-3">
            <label class="form-label">Indicadores de la visita</label>
            <canvas id="infChartDonut" height="130"></canvas>
          </div>
        </div>
      </div>

      <hr />

      <div class="row g-3">
        <div class="col-md-4">
          <h6 class="mb-2">Formaciones y dinamización</h6>
          <div class="informe-scroll">
            <strong>Formaciones relevantes</strong>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="WSA" id="fWSA">
              <label class="form-check-label" for="fWSA">WSA</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="Starkey" id="fStarkey">
              <label class="form-check-label" for="fStarkey">Starkey</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="Ventas" id="fVentas">
              <label class="form-check-label" for="fVentas">Ventas</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="HIT" id="fHIT">
              <label class="form-check-label" for="fHIT">HIT</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="Telecare" id="fTelecare">
              <label class="form-check-label" for="fTelecare">Telecare</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="PIA" id="fPIA">
              <label class="form-check-label" for="fPIA">PIA</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="Telehear" id="fTelehear">
              <label class="form-check-label" for="fTelehear">Telehear</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="Infinity" id="fInfinity">
              <label class="form-check-label" for="fInfinity">Infinity</label>
            </div>
            <hr />
            <strong>Dinamización y elementos audio</strong>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="dAudiometria">
              <label class="form-check-label" for="dAudiometria">Audiometría a RT</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="dTestLectura">
              <label class="form-check-label" for="dTestLectura">Test de lectura audio</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="dScreening">
              <label class="form-check-label" for="dScreening">Screening audio</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="dManteleta">
              <label class="form-check-label" for="dManteleta">Manteleta audio</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="dEscaparate">
              <label class="form-check-label" for="dEscaparate">Escaparate completo audio</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="dSaludPDV">
              <label class="form-check-label" for="dSaludPDV">Elementos de salud auditiva en PDV</label>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <h6 class="mb-2">Áreas de mejora (automáticas por F=0)</h6>
          <div class="informe-scroll" id="infAreasMejora">
            <p class="text-muted small mb-0">Cuando adjuntes el checklist Excel, se buscarán celdas con valor 0 y se listarán aquí como posibles áreas de mejora. Puedes editar el texto posteriormente.</p>
          </div>
        </div>
        <div class="col-md-4">
          <h6 class="mb-2">Imágenes</h6>
          <div class="small">
            <label class="form-label">Exterior</label>
            <input type="file" class="form-control form-control-sm mb-2 inf-img-input" data-target="infImgExterior" accept="image/*" />
            <div class="informe-img-preview mb-2">
              <img id="infImgExterior" alt="Exterior" />
            </div>
            <label class="form-label">Interior</label>
            <input type="file" class="form-control form-control-sm mb-2 inf-img-input" data-target="infImgInterior" accept="image/*" />
            <div class="informe-img-preview mb-2">
              <img id="infImgInterior" alt="Interior" />
            </div>
            <label class="form-label">Gabinete</label>
            <input type="file" class="form-control form-control-sm mb-2 inf-img-input" data-target="infImgGabinete" accept="image/*" />
            <div class="informe-img-preview">
              <img id="infImgGabinete" alt="Gabinete" />
            </div>
          </div>
        </div>
      </div>

      <hr />

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Observaciones - Recomendaciones - Compromisos</label>
          <textarea class="form-control form-control-sm" id="infObservaciones" rows="4"></textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">Resumen automático</label>
          <textarea class="form-control form-control-sm" id="infResumenAuto" rows="4" readonly></textarea>
        </div>
      </div>

      <div class="mt-3 d-flex justify-content-end">
        <button type="button" class="btn btn-danger btn-sm me-2" id="btnCerrarInforme">
          <i class="bi bi-x-circle me-1"></i>Cerrar
        </button>
        <button type="button" class="btn btn-success btn-sm" id="btnGenerarInforme">
          <i class="bi bi-file-earmark-pdf me-1"></i>Generar informe completo (PDF)
        </button>
      </div>
    </div>
  </template>

  <!-- JS libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Custom JS -->
  <script src="js/state.js"></script>
  <script src="js/excelReader.js"></script>
  <script src="js/mapHandler.js"></script>
  <script src="js/dashboard.js"></script>
  <script src="js/visitas.js"></script>
  <script src="js/informe.js"></script>
</body>
</html>
"""

with open(os.path.join(base_dir, "index.html"), "w", encoding="utf-8") as f:
    f.write(index_html)

css_content = """
:root {
  --cca-bg: #0f172a;
  --cca-bg-soft: rgba(15, 23, 42, 0.88);
  --cca-panel-bg: rgba(15, 23, 42, 0.96);
  --cca-accent: #f97316;
  --cca-accent-soft: rgba(249, 115, 22, 0.2);
  --cca-border: rgba(148, 163, 184, 0.3);
  --cca-text-main: #e5e7eb;
  --cca-text-soft: #9ca3af;
}

body.cca-body {
  min-height: 100vh;
  background: radial-gradient(circle at top left, #1e293b 0, #020617 45%, #020617 100%);
  color: var(--cca-text-main);
  font-size: 0.9rem;
}

.cca-app {
  min-height: 100vh;
}

/* Sidebar */
.cca-sidebar {
  width: 230px;
  background: linear-gradient(180deg, #111827 0%, #020617 80%);
  border-right: 1px solid var(--cca-border);
  color: #e5e7eb;
}

.cca-sidebar-nav .nav-link {
  border-radius: 0;
  color: var(--cca-text-soft);
  padding: 0.8rem 1.5rem;
  text-align: left;
  font-weight: 500;
  border-left: 3px solid transparent;
}

.cca-sidebar-nav .nav-link i {
  font-size: 1rem;
}

.cca-sidebar-nav .nav-link:hover {
  background: rgba(15, 23, 42, 0.9);
  color: #f9fafb;
}

.cca-sidebar-nav .nav-link.active {
  background: linear-gradient(90deg, rgba(249,115,22,0.25), transparent);
  color: #fefce8;
  border-left-color: var(--cca-accent);
}

/* Main + Topbar */
.cca-main {
  display: flex;
  flex-direction: column;
}

.cca-topbar {
  padding: 0.75rem 1.25rem;
  border-bottom: 1px solid var(--cca-border);
  background: radial-gradient(circle at top right, rgba(249, 115, 22, 0.08), rgba(15, 23, 42, 0.96));
  position: sticky;
  top: 0;
  z-index: 10;
}

.cca-search-input {
  padding-left: 2.2rem;
  background: rgba(15, 23, 42, 0.85);
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.5);
  color: #e5e7eb;
}

.cca-search-input::placeholder {
  color: #6b7280;
}

.cca-search-icon {
  position: absolute;
  left: 0.9rem;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  font-size: 0.95rem;
}

/* 3D buttons */
.btn-cca-3d {
  border-radius: 999px;
  border: none;
  padding: 0.5rem 0.7rem;
  background: radial-gradient(circle at 30% 0%, rgba(248, 250, 252, 0.25), rgba(148, 163, 184, 0.15));
  box-shadow: 0 8px 16px rgba(15, 23, 42, 0.75), inset 0 0 0 1px rgba(148, 163, 184, 0.4);
  color: #e5e7eb;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
}

.btn-cca-3d:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 20px rgba(15, 23, 42, 0.9), inset 0 0 0 1px rgba(249, 250, 251, 0.5);
  background: radial-gradient(circle at 30% 0%, rgba(248, 250, 252, 0.45), rgba(148, 163, 184, 0.25));
}

.btn-cca-3d:active {
  transform: translateY(1px) scale(0.98);
  box-shadow: 0 4px 10px rgba(15, 23, 42, 0.8);
}

/* Sections */
.cca-section {
  display: none;
}

.cca-section.active {
  display: block;
}

.section-title {
  font-size: 1.15rem;
}

/* Panels */
.cca-panel {
  border-radius: 1rem;
  padding: 1rem 1.1rem;
  background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.95));
  border: 1px solid rgba(148, 163, 184, 0.4);
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
}

/* KPI cards */
.cca-kpi-card {
  border-radius: 1rem;
  padding: 0.9rem 1rem;
  background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(30, 64, 175, 0.4));
  border: 1px solid rgba(148, 163, 184, 0.55);
  box-shadow: 0 18px 30px rgba(15, 23, 42, 0.95);
}

.kpi-label {
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--cca-text-soft);
}

.kpi-value {
  font-size: 1.3rem;
  font-weight: 700;
}

.kpi-sub {
  font-size: 0.75rem;
  color: var(--cca-text-soft);
}

/* Mini KPI */
.mini-kpi-label {
  font-size: 0.7rem;
  color: var(--cca-text-soft);
}

.mini-kpi-value {
  font-size: 0.95rem;
  font-weight: 600;
}

/* Tables */
.table {
  color: #e5e7eb;
}

.table thead.table-light {
  background: rgba(15, 23, 42, 0.9);
  color: #e5e7eb;
}

.table-hover tbody tr:hover {
  background-color: rgba(15, 23, 42, 0.85);
}

/* Map */
.cca-map {
  width: 100%;
  height: 280px;
  border-radius: 0.75rem;
  overflow: hidden;
  border: 1px solid rgba(148, 163, 184, 0.4);
}

/* Calendario visitas */
#visitasCalendar table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  font-size: 0.8rem;
}

#visitasCalendar th,
#visitasCalendar td {
  text-align: center;
  padding: 0.4rem 0.1rem;
}

#visitasCalendar th {
  color: var(--cca-text-soft);
}

#visitasCalendar td {
  cursor: pointer;
  border-radius: 0.4rem;
}

#visitasCalendar td:hover {
  background: rgba(30, 64, 175, 0.3);
}

.cal-dia-actual {
  border: 1px solid var(--cca-accent);
}

.cal-dia-sin-mes {
  opacity: 0.3;
}

.estado-dot {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 999px;
}

.estado-pendiente {
  background: #facc15;
}

.estado-realizada {
  background: #22c55e;
}

.estado-anulada {
  background: #ef4444;
}

/* Informe visita */
.informe-visita {
  border-radius: 1rem;
  border: 1px dashed rgba(148, 163, 184, 0.6);
  padding: 0.8rem;
  background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.9));
}

.informe-scroll {
  max-height: 260px;
  overflow-y: auto;
  padding-right: 0.25rem;
}

.informe-img-preview {
  background: rgba(15, 23, 42, 0.8);
  border-radius: 0.5rem;
  border: 1px solid rgba(148, 163, 184, 0.5);
  height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.informe-img-preview img {
  max-height: 85px;
  max-width: 100%;
  object-fit: contain;
}

/* Util */
.text-light-50 {
  color: rgba(209, 213, 219, 0.5);
}

/* Responsive */
@media (max-width: 992px) {
  .cca-sidebar {
    display: none;
  }
  .cca-main {
    width: 100%;
  }
}
"""

with open(os.path.join(base_dir, "css", "style.css"), "w", encoding="utf-8") as f:
    f.write(css_content)

state_js = """
// Estado global de la aplicación
window.CCAState = {
  centros: [],
  visitas: [],
  exclusivos: [],
  proyectos: [],
  aar: []
};

window.CCACharts = {};
window.CCAMap = null;
window.CCADelegadoColors = {};

// Utilidad para generar colores por delegado
function getColorForDelegado(nombre) {
  if (!nombre) return "#38bdf8";
  if (window.CCADelegadoColors[nombre]) return window.CCADelegadoColors[nombre];
  const palette = ["#f97316", "#22c55e", "#38bdf8", "#eab308", "#a855f7", "#ec4899", "#0ea5e9", "#facc15"];
  const idx = Object.keys(window.CCADelegadoColors).length % palette.length;
  window.CCADelegadoColors[nombre] = palette[idx];
  return window.CCADelegadoColors[nombre];
}

// Guardado / carga localStorage
function saveStateLocal() {
  try {
    localStorage.setItem("CCAState", JSON.stringify(window.CCAState));
    alert("Estado guardado localmente.");
  } catch (e) {
    console.error(e);
    alert("No se pudo guardar el estado localmente.");
  }
}

function loadStateLocal() {
  try {
    const raw = localStorage.getItem("CCAState");
    if (!raw) return;
    const data = JSON.parse(raw);
    if (data && typeof data === "object") {
      window.CCAState = Object.assign(window.CCAState, data);
    }
  } catch (e) {
    console.error(e);
  }
}

// Export / import JSON (simulación nube)
function exportStateJSON() {
  const blob = new Blob([JSON.stringify(window.CCAState, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "control-center-audio-backup.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importStateJSON(file) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (data && typeof data === "object") {
        window.CCAState = Object.assign(window.CCAState, data);
        alert("Backup cargado. Refresca las vistas para ver los datos.");
        // Podrías llamar aquí a funciones de refresco si quieres que sea automático.
      }
    } catch (err) {
      console.error(err);
      alert("El archivo no es un backup válido.");
    }
  };
  reader.readAsText(file);
}

// Descargar HTML actual
function downloadCurrentHTML() {
  const html = "<!DOCTYPE html>" + document.documentElement.outerHTML;
  const blob = new Blob([html], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ControlCenterAudio-export.html";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
"""

with open(os.path.join(base_dir, "js", "state.js"), "w", encoding="utf-8") as f:
    f.write(state_js)

excel_js = """
// Lectura de Excel para KPIs definidos
async function parseChecklistFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];

        const nombre = (file.name || "").toLowerCase();
        let tipo = "CORNER";
        if (nombre.includes("exclu")) tipo = "EXCLUSIVO";
        else if (nombre.includes("corner")) tipo = "CORNER";

        function getCell(addr) {
          const cell = sheet[addr];
          return cell ? cell.v : null;
        }

        let procesos, aplicaHit, convPrueba, convVenta;

        if (tipo === "CORNER") {
          procesos = getCell("F90");
          aplicaHit = getCell("F63");
          convPrueba = getCell("B92");
          convVenta = getCell("B93");
        } else {
          procesos = getCell("F104");
          aplicaHit = getCell("F65");
          convPrueba = getCell("I126");
          convVenta = getCell("I127");
        }

        // Búsqueda genérica de celdas con 0 como áreas de mejora
        const areasMejora = [];
        const range = XLSX.utils.decode_range(sheet["!ref"] || "A1:A1");
        for (let R = range.s.r; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const addr = XLSX.utils.encode_cell({ r: R, c: C });
            const cell = sheet[addr];
            if (!cell) continue;
            if (cell.v === 0 || cell.v === "0") {
              areasMejora.push("Celda " + addr + " = 0");
            }
          }
        }

        resolve({
          tipo,
          procesos: Number(procesos) || 0,
          aplicaHit: Number(aplicaHit) || 0,
          convPrueba: Number(convPrueba) || 0,
          convVenta: Number(convVenta) || 0,
          areasMejora
        });
      } catch (err) {
        console.error(err);
        reject(err);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}
"""

with open(os.path.join(base_dir, "js", "excelReader.js"), "w", encoding="utf-8") as f:
    f.write(excel_js)

map_js = """
function initCCAMap(elementId) {
  const mapElement = document.getElementById(elementId);
  if (!mapElement) return null;
  const map = L.map(elementId, {
    center: [40.0, -3.7],
    zoom: 5.2,
    zoomControl: true
  });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "© OpenStreetMap"
  }).addTo(map);
  return map;
}

function refreshMaps() {
  // dashboard map
  if (!window.CCACharts.mapInitedDashboard) {
    window.CCAMapDashboard = initCCAMap("mapCentros");
    window.CCACharts.mapInitedDashboard = true;
  }
  if (!window.CCACharts.mapInitedCentros) {
    window.CCAMap = initCCAMap("mapCentrosSection");
    window.CCACharts.mapInitedCentros = true;
  }
  drawCentersOnMaps();
}

function drawCentersOnMaps() {
  if (!window.CCAMap && !window.CCAMapDashboard) return;

  // Clear existing layers except tile
  [window.CCAMap, window.CCAMapDashboard].forEach(map => {
    if (!map) return;
    map.eachLayer(layer => {
      if (!(layer instanceof L.TileLayer)) {
        map.removeLayer(layer);
      }
    });
  });

  window.CCAState.centros.forEach(c => {
    if (c.lat == null || c.lng == null) return;
    const color = getColorForDelegado(c.delegado);
    const markerOptions = {
      radius: 7,
      fillColor: color,
      color: "#0f172a",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.9
    };
    [window.CCAMap, window.CCAMapDashboard].forEach(map => {
      if (!map) return;
      const circle = L.circleMarker([c.lat, c.lng], markerOptions).addTo(map);
      circle.bindPopup("<strong>" + (c.nombre || "") + "</strong><br/>" + (c.delegado || "") + "<br/><span class='badge bg-secondary'>" + (c.tipo || "") + "</span>");
    });
  });
}
"""

with open(os.path.join(base_dir, "js", "mapHandler.js"), "w", encoding="utf-8") as f:
    f.write(map_js)

dashboard_js = """
document.addEventListener("DOMContentLoaded", () => {
  // Cargar estado previo si existe
  loadStateLocal();

  // Navegación lateral
  document.querySelectorAll(".cca-sidebar-nav .nav-link").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".cca-sidebar-nav .nav-link").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const target = btn.getAttribute("data-section");
      document.querySelectorAll(".cca-section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(target).classList.add("active");
      if (target === "centros") refreshMaps();
      if (target === "dashboard") {
        refreshMaps();
        updateDashboardCharts();
      }
    });
  });

  // Botones topbar
  document.getElementById("btnSaveLocal").addEventListener("click", saveStateLocal);
  document.getElementById("btnSaveCloud").addEventListener("click", exportStateJSON);
  document.getElementById("btnDownloadHtml").addEventListener("click", downloadCurrentHTML);
  document.getElementById("btnLoadCloud").addEventListener("click", () => {
    document.getElementById("cloudFileInput").click();
  });
  document.getElementById("cloudFileInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) importStateJSON(file);
  });

  // Buscador global muy sencillo (marca texto)
  const globalSearch = document.getElementById("globalSearch");
  globalSearch.addEventListener("input", () => {
    const term = globalSearch.value.trim().toLowerCase();
    document.querySelectorAll(".cca-section.active table tbody tr").forEach(tr => {
      if (!term) {
        tr.classList.remove("d-none");
        return;
      }
      const text = tr.innerText.toLowerCase();
      tr.classList.toggle("d-none", !text.includes(term));
    });
  });

  initCentrosSection();
  initVisitasSection();
  initExclusivosSection();
  initProyectosSection();
  initAarSection();

  // Inicializar gráficos generales
  initDashboardCharts();
  refreshMaps();
  updateDashboardCharts();
});

/* --------- Dashboard charts ---------- */
function initDashboardCharts() {
  const kpiCtx = document.getElementById("kpiChart");
  if (kpiCtx) {
    window.CCACharts.kpiChart = new Chart(kpiCtx, {
      type: "bar",
      data: {
        labels: ["% Procesos", "Conv. prueba", "Conv. venta"],
        datasets: [{
          label: "Media global",
          data: [0, 0, 0]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: value => value + "%"
            }
          }
        }
      }
    });
  }

  const vCtx = document.getElementById("visitasChart");
  if (vCtx) {
    window.CCACharts.visitasChart = new Chart(vCtx, {
      type: "doughnut",
      data: {
        labels: ["Pendientes", "Realizadas", "Anuladas"],
        datasets: [{
          data: [0, 0, 0]
        }]
      },
      options: {
        plugins: {
          legend: { position: "bottom" }
        }
      }
    });
  }
}

function updateDashboardCharts() {
  // KPIs globales
  const centros = window.CCAState.centros;
  let sumProc = 0, sumPrueba = 0, sumVenta = 0, hitCount = 0, hitAplica = 0;
  centros.forEach(c => {
    if (c.kpis) {
      sumProc += c.kpis.procesos || 0;
      sumPrueba += c.kpis.convPrueba || 0;
      sumVenta += c.kpis.convVenta || 0;
      if (c.kpis.aplicaHit) {
        hitCount++;
        hitAplica += c.kpis.aplicaHit;
      }
    }
  });
  const n = centros.length || 1;
  const mediaProc = sumProc / n;
  const mediaPrueba = sumPrueba / n;
  const mediaVenta = sumVenta / n;

  document.getElementById("kpiProcesos").innerText = mediaProc.toFixed(1) + "%";
  document.getElementById("kpiPrueba").innerText = mediaPrueba.toFixed(1) + "%";
  document.getElementById("kpiVenta").innerText = mediaVenta.toFixed(1) + "%";
  document.getElementById("kpiHit").innerText = hitCount.toString();

  if (window.CCACharts.kpiChart) {
    window.CCACharts.kpiChart.data.datasets[0].data = [mediaProc, mediaPrueba, mediaVenta];
    window.CCACharts.kpiChart.update();
  }

  // Visitas
  const visitas = window.CCAState.visitas;
  let pend = 0, real = 0, anul = 0;
  visitas.forEach(v => {
    if (v.estado === "pendiente") pend++;
    else if (v.estado === "realizada") real++;
    else if (v.estado === "anulada") anul++;
  });
  if (window.CCACharts.visitasChart) {
    window.CCACharts.visitasChart.data.datasets[0].data = [pend, real, anul];
    window.CCACharts.visitasChart.update();
  }

  // Ranking de centros
  renderRankingCentros();
}

/* --------- Centors section ---------- */

function initCentrosSection() {
  const form = document.getElementById("formCentro");
  const filtro = document.getElementById("filtroCentros");
  const tablaBody = document.querySelector("#tablaCentros tbody");

  function renderTabla() {
    if (!tablaBody) return;
    tablaBody.innerHTML = "";
    let data = [...window.CCAState.centros];
    const term = (filtro.value || "").toLowerCase();
    if (term) {
      data = data.filter(c =>
        (c.nombre || "").toLowerCase().includes(term) ||
        (c.delegado || "").toLowerCase().includes(term) ||
        (c.provincia || "").toLowerCase().includes(term)
      );
    }
    data.sort((a, b) => (b.kpis?.convVenta || 0) - (a.kpis?.convVenta || 0));
    data.forEach(c => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.nombre || ""}</td>
        <td>${c.delegado || ""}</td>
        <td><span class="badge bg-secondary">${c.tipo || ""}</span></td>
        <td>${c.provincia || ""}</td>
        <td class="text-end">${c.kpis ? (c.kpis.convVenta || 0).toFixed(1) + "%" : "-"}</td>
      `;
      tr.addEventListener("click", () => {
        setCentroResumen(c);
      });
      tablaBody.appendChild(tr);
    });
  }

  filtro.addEventListener("input", renderTabla);

  form.addEventListener("submit", async e => {
    e.preventDefault();
    const nombre = document.getElementById("centroNombre").value.trim();
    if (!nombre) {
      alert("Introduce al menos el nombre del centro.");
      return;
    }
    const centro = {
      id: Date.now(),
      nombre,
      codigo: document.getElementById("centroCodigo").value.trim(),
      delegado: document.getElementById("centroDelegado").value.trim(),
      tipo: document.getElementById("centroTipo").value,
      provincia: document.getElementById("centroProvincia").value.trim(),
      lat: parseFloat(document.getElementById("centroLat").value) || null,
      lng: parseFloat(document.getElementById("centroLng").value) || null,
      kpis: null
    };

    const fileInput = document.getElementById("centroChecklist");
    if (fileInput.files && fileInput.files[0]) {
      try {
        const parsed = await parseChecklistFile(fileInput.files[0]);
        centro.tipo = parsed.tipo || centro.tipo;
        centro.kpis = parsed;
        alert("Checklist leído correctamente. KPIs aplicados al centro.");
      } catch (err) {
        alert("No se pudo leer el checklist. El centro se guardará sin KPIs.");
      }
    }

    window.CCAState.centros.push(centro);
    form.reset();
    renderTabla();
    refreshMaps();
    updateDashboardCharts();
  });

  function setCentroResumen(c) {
    document.getElementById("centroNombre").value = c.nombre || "";
    document.getElementById("centroCodigo").value = c.codigo || "";
    document.getElementById("centroDelegado").value = c.delegado || "";
    document.getElementById("centroTipo").value = c.tipo || "CORNER";
    document.getElementById("centroProvincia").value = c.provincia || "";
    document.getElementById("centroLat").value = c.lat || "";
    document.getElementById("centroLng").value = c.lng || "";
    if (c.kpis) {
      document.getElementById("centroKpiProcesos").innerText = c.kpis.procesos.toFixed(1) + "%";
      document.getElementById("centroKpiHit").innerText = c.kpis.aplicaHit;
      document.getElementById("centroKpiPrueba").innerText = c.kpis.convPrueba.toFixed(1) + "%";
      document.getElementById("centroKpiVenta").innerText = c.kpis.convVenta.toFixed(1) + "%";
    } else {
      document.getElementById("centroKpiProcesos").innerText = "-";
      document.getElementById("centroKpiHit").innerText = "-";
      document.getElementById("centroKpiPrueba").innerText = "-";
      document.getElementById("centroKpiVenta").innerText = "-";
    }
  }

  renderTabla();
  refreshMaps();
}

// Ranking en dashboard
function renderRankingCentros() {
  const tbody = document.querySelector("#tablaRankingCentros tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  const data = [...window.CCAState.centros].sort((a, b) => (b.kpis?.convVenta || 0) - (a.kpis?.convVenta || 0));
  data.forEach(c => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.nombre || ""}</td>
      <td>${c.delegado || ""}</td>
      <td><span class="badge bg-secondary">${c.tipo || ""}</span></td>
      <td class="text-end">${c.kpis ? (c.kpis.convVenta || 0).toFixed(1) + "%" : "-"}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* --------- Exclusivos section ---------- */
function initExclusivosSection() {
  const form = document.getElementById("formExclusivo");
  const filtro = document.getElementById("filtroExclusivos");
  const tablaBody = document.querySelector("#tablaExclusivos tbody");

  function renderTabla() {
    tablaBody.innerHTML = "";
    let data = [...window.CCAState.exclusivos];
    const term = (filtro.value || "").toLowerCase();
    if (term) {
      data = data.filter(e =>
        (e.centro || "").toLowerCase().includes(term)
      );
    }
    data.forEach(e => {
      const diff = e.cifraReal - e.cifraEstimada;
      const diffStr = (diff >= 0 ? "+" : "") + diff.toFixed(0);
      const cls = diff >= 0 ? "text-success" : "text-danger";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${e.centro || ""}</td>
        <td>${e.periodo || ""}</td>
        <td class="text-end">${e.cifraReal.toFixed(0)}</td>
        <td class="text-end">${e.cifraEstimada.toFixed(0)}</td>
        <td class="text-end ${cls}">${diffStr}</td>
      `;
      tablaBody.appendChild(tr);
    });
  }

  function refreshChart() {
    const ctx = document.getElementById("exclusivosChart");
    if (!ctx) return;
    const totalReal = window.CCAState.exclusivos.reduce((s, e) => s + (e.cifraReal || 0), 0);
    const totalEst = window.CCAState.exclusivos.reduce((s, e) => s + (e.cifraEstimada || 0), 0);
    if (!window.CCACharts.exclusivosChart) {
      window.CCACharts.exclusivosChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Real acumulado", "Estimado acumulado"],
          datasets: [{
            data: [totalReal, totalEst]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          }
        }
      });
    } else {
      window.CCACharts.exclusivosChart.data.datasets[0].data = [totalReal, totalEst];
      window.CCACharts.exclusivosChart.update();
    }
  }

  form.addEventListener("submit", e => {
    e.preventDefault();
    const reg = {
      id: Date.now(),
      centro: document.getElementById("exCentro").value.trim(),
      periodo: document.getElementById("exPeriodo").value,
      cifraReal: Number(document.getElementById("exCifraReal").value) || 0,
      cifraEstimada: Number(document.getElementById("exCifraEstimada").value) || 0,
      accion: document.getElementById("exAccion").value,
      derivaciones: Number(document.getElementById("exDerivaciones").value) || 0,
      citas: Number(document.getElementById("exCitas").value) || 0,
      obs: document.getElementById("exObs").value
    };
    window.CCAState.exclusivos.push(reg);
    form.reset();
    renderTabla();
    refreshChart();
  });

  filtro.addEventListener("input", renderTabla);

  renderTabla();
  refreshChart();
}

/* --------- Proyectos section ---------- */
function initProyectosSection() {
  const form = document.getElementById("formProyecto");
  const filtro = document.getElementById("filtroProyectos");
  const tablaBody = document.querySelector("#tablaProyectos tbody");

  function renderTabla() {
    tablaBody.innerHTML = "";
    let data = [...window.CCAState.proyectos];
    const term = (filtro.value || "").toLowerCase();
    if (term) {
      data = data.filter(p =>
        (p.nombre || "").toLowerCase().includes(term) ||
        (p.responsable || "").toLowerCase
